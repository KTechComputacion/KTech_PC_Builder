{% extends "base.html" %}
{% block content %}
<h1>Eliminar - Editar componentes</h1>

<div class="table-wrap">
  <table class="summary-table resizable-table" id="editTable">
    <colgroup>
      <col style="width:150px">
      <col style="width:420px">
      <col style="width:140px">
      <col style="width:120px">
      <col style="width:110px">
      <col style="width:170px">
    </colgroup>
    <thead>
      <tr>
        <th data-col="0">Categor√≠a <span class="col-resizer" draggable="true"></span></th>
        <th data-col="1">Nombre <span class="col-resizer" draggable="true"></span></th>
        <th data-col="2">C√≥digo <span class="col-resizer" draggable="true"></span></th>
        <th class="right" data-col="3">Precio <span class="col-resizer" draggable="true"></span></th>
        <th class="right" data-col="4">Stock <span class="col-resizer" draggable="true"></span></th>
        <th class="right" data-col="5">Acciones <span class="col-resizer" draggable="true"></span></th>
      </tr>
    </thead>
    <tbody>
      {% for row in items %}
      <tr>
        <!-- Form flotante para editar esta fila -->
        <form id="edit-{{ loop.index }}" class="row-edit-form" method="post" action="{{ url_for('update_item') }}"></form>

        <td>{{ row.categoria }}</td>

        <td class="cell-input">
          <input form="edit-{{ loop.index }}" class="fit-input name-input" type="text" name="nombre" value="{{ row.nombre }}" title="{{ row.nombre }}" readonly>
          <input form="edit-{{ loop.index }}" type="hidden" name="categoria" value="{{ row.categoria }}">
          <input form="edit-{{ loop.index }}" type="hidden" name="original_codigo" value="{{ row.codigo }}">
        </td>

        <td class="cell-input">
          <input form="edit-{{ loop.index }}" class="fit-input code-input" type="text" name="codigo" value="{{ row.codigo }}" title="{{ row.codigo }}" readonly>
        </td>

        <td class="right cell-input">
          <input form="edit-{{ loop.index }}" class="fit-input num-input" type="number" name="precio" value="{{ row.precio }}" readonly>
        </td>

        <td class="right cell-input">
          <input form="edit-{{ loop.index }}" class="fit-input num-input" type="number" name="stock" value="{{ row.stock }}" readonly>
        </td>

        <td class="right">
          <div class="row-actions">
            <!-- Eliminar: propio form -->
            <form method="post"
                  action="{{ url_for('delete_item') }}"
                  onsubmit="return confirm('¬øEliminar este componente?\\n\\n{{ row.categoria }}\\n{{ row.nombre }}\\nC√≥digo: {{ row.codigo }}');">
              <input type="hidden" name="categoria" value="{{ row.categoria }}">
              <input type="hidden" name="codigo" value="{{ row.codigo }}">
              <button class="btn btn-danger btn-ghost" type="submit" title="Eliminar">‚ùå</button>
            </form>

            <!-- Editar / Guardar (apunta al form de la fila) -->
            <button type="button" class="btn btn-warning btn-ghost" title="Editar" onclick="enableEdit(this)">‚úèÔ∏è</button>
            <button form="edit-{{ loop.index }}" type="submit" class="btn btn-success btn-ghost save-btn" style="display:none;">üíæ</button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function enableEdit(btn){
    const row = btn.closest('tr');
    row.classList.add('editing');
    row.querySelectorAll('.cell-input input').forEach(inp => inp.removeAttribute('readonly'));
    const saveBtn = row.querySelector('.save-btn');
    if(saveBtn) saveBtn.style.display = 'inline-block';
  }

  // Column resize logic
  (function(){
    const table = document.getElementById('editTable');
    if(!table) return;
    const colgroup = table.querySelector('colgroup');
    if(!colgroup) return;

    let startX = 0;
    let startWidth = 0;
    let activeCol = null;

    table.querySelectorAll('th .col-resizer').forEach(handle => {
      handle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const th = e.target.closest('th');
        activeCol = parseInt(th.getAttribute('data-col'), 10);
        startX = e.pageX;
        const colEl = colgroup.children[activeCol];
        startWidth = colEl.offsetWidth;
        document.body.classList.add('resizing');
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    });

    function onMove(e){
      if(activeCol === null) return;
      const dx = e.pageX - startX;
      const newW = Math.max(80, startWidth + dx);
      colgroup.children[activeCol].style.width = newW + 'px';
    }
    function onUp(){
      document.body.classList.remove('resizing');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      activeCol = null;
    }
  })();
</script>
{% endblock %}